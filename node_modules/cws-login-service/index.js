'use strict';

var jsonWebToken = require('jsonwebtoken');

var databaseService = require('cws-database-service');
var logger = require('cws-logger');
var models = require('cws-models');
var config = require('cws-config');

var filename = 'LoginService';

var User = models.getUserModel();

exports.login = function(emailId, password) {
	var promise = new Promise(function(resolve, reject) {
		if (!emailId) {
			logger.error(filename, 'login:' + 'emailId is null');
			reject(new Error('emailId is null'));
		}

		if (!password) {
			logger.error(filename, 'login:' + 'password is null');
			reject(new Error('password is null'));
		}

		databaseService.findOne(User, { 'emailId': emailId })
			.then(function(user) {

				if (user.password == password) {
					var token = jsonWebToken.sign(user, config.secretKey, {
          				expiresInMinutes: 1440 // expires in 24 hours
        			});
					logger.info(filename, 'login:' + 'User validated');
					resolve({ 'userId': user.userId,
							  'token': token });
				} else {
					logger.error(filename, 'login:' + 'password is invalid');
					reject(new Error('password is invalid'));
				}
			}, function(err) {

				logger.error(filename, 'login:' + err);
				reject(err);
			});			
	});

	return promise;
};